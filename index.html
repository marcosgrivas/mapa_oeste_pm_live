<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Mapa de Territorios</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet Rotate -->
  <script src="https://unpkg.com/leaflet-rotate/dist/leaflet-rotate.min.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    #map {
      height: 100%;
      width: 100%;
    }

    /* Botonera */
    .controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 8px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    .controls button {
      display: block;
      width: 100%;
      margin-bottom: 6px;
      font-size: 14px;
    }

    /* Etiquetas territorio */
    .label-territorio {
      background: transparent !important;
      border: none !important;
      padding: 0 !important;
      font-size: 14px;
      font-weight: 700;
      color: #000;
      white-space: nowrap;
      text-shadow:
        -2px -2px 0 #fff,
         2px -2px 0 #fff,
        -2px  2px 0 #fff,
         2px  2px 0 #fff;
    }

    /* Etiquetas manzana */
    .label-manzana {
      background: transparent !important;
      border: none !important;
      padding: 0 !important;
      font-size: 12px;
      font-weight: 600;
      color: #000;
      white-space: nowrap;
      text-shadow:
        -1px -1px 0 #fff,
         1px -1px 0 #fff,
        -1px  1px 0 #fff,
         1px  1px 0 #fff;
    }
  </style>
</head>

<body>

<div id="map"></div>

<div class="controls">
  <button onclick="locateUser()"> Mi ubicaci贸n</button>
  <button onclick="requestOrientationPermission()">Л Orientaci贸n</button>
</div>

<script>
  // =============================
  // MAPA
  // =============================
  const map = L.map('map', {
    zoomControl: false,
    rotate: true,
    touchRotate: true
  }).setView([-34.6, -58.4], 14);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '漏 OpenStreetMap'
  }).addTo(map);

  // =============================
  // COLORES
  // =============================
  function colorPorTerritorio(id) {
    const colores = {
     "0":  "#c6dbef",
      "1":  "#78a5b5",
      "2":  "#f7c99b",
      "3":  "#eeeeb2",
      "4":  "#a3bedb",
      "5":  "#db736c",
      "6":  "#89c79b",
      "7":  "#b4cde3",
      "8":  "#f5e5b5",
      "9":  "#e48571",
      "10": "#7094c2",
      "11": "#f4b98c",
      "12": "#9cd78e",
      "13": "#81a2ca",
      "14": "#f0a882",
      "15": "#f0a882",
      "16": "#b0e684",
      "17": "#f7d8aa",
      "18": "#d06267",
      "19": "#92b0d2",
      "20": "#c6ec8a",
      "21": "#eb9678",
      "22": "#80b6a8",
      "23": "#b4445a",
      "24": "#dcf0a0",
      "25": "#a53752"
    };
    return colores[String(id)] || "#cccccc";
  }

  // =============================
  // LAYERS
  // =============================
  let layerTerritorios, layerManzanas;
  let labelsTerritorios = L.layerGroup().addTo(map);
  let labelsManzanas = L.layerGroup();

  // ---- Territorios
  fetch('territorios.geojson')
    .then(r => r.json())
    .then(data => {
      layerTerritorios = L.geoJSON(data, {
        style: f => ({
          color: '#333',
          weight: 1,
          fillColor: colorPorTerritorio(f.properties.id_terr),
          fillOpacity: 0.5
        })
      }).addTo(map);

      data.features.forEach(f => {
        const c = L.geoJSON(f).getBounds().getCenter();
        L.marker(c, {
          icon: L.divIcon({
            className: 'label-territorio',
            html: `${f.properties.id_terr}`
          }),
          interactive: false
        }).addTo(labelsTerritorios);
      });

      map.fitBounds(layerTerritorios.getBounds());
    });

  // ---- Manzanas
  fetch('manzanas.geojson')
    .then(r => r.json())
    .then(data => {
      layerManzanas = L.geoJSON(data, {
        style: f => ({
          color: '#333',
          weight: 1,
          fillColor: colorPorTerritorio(f.properties.id_terr),
          fillOpacity: 0.5
        })
      });

      data.features.forEach(f => {
        const c = L.geoJSON(f).getBounds().getCenter();
        L.marker(c, {
          icon: L.divIcon({
            className: 'label-manzana',
            html: `${f.properties.id_mza}`
          }),
          interactive: false
        }).addTo(labelsManzanas);
      });
    });

  // =============================
  // ZOOM LOGIC
  // =============================
  const ZOOM_CORTE = 16;

  function updateLayersByZoom() {
    const z = map.getZoom();

    if (z < ZOOM_CORTE) {
      map.addLayer(layerTerritorios);
      map.removeLayer(layerManzanas);
      map.removeLayer(labelsManzanas);
    } else {
      map.removeLayer(layerTerritorios);
      map.addLayer(layerManzanas);
      map.addLayer(labelsManzanas);
    }
  }

  map.on('zoomend', updateLayersByZoom);
  map.whenReady(updateLayersByZoom);

  // =============================
  // UBICACIN
  // =============================
  let userMarker, userAccuracy;

  function locateUser() {
  let firstFix = true;
  map.locate({
    watch: true,
    enableHighAccuracy: true
  });

  map.on('locationfound', e => {
    if (firstFix) {
      map.setView(e.latlng, 17);
      firstFix = false;
    }
  });
  }

  map.on('locationfound', e => {
    if (userMarker) map.removeLayer(userMarker);
    if (userAccuracy) map.removeLayer(userAccuracy);

    userMarker = L.circleMarker(e.latlng, {
      radius: 6,
      color: '#fff',
      weight: 2,
      fillColor: '#007bff',
      fillOpacity: 1
    }).addTo(map);

    userAccuracy = L.circle(e.latlng, {
      radius: e.accuracy,
      color: '#007bff',
      weight: 1,
      fillOpacity: 0.15
    }).addTo(map);
  });

  // =============================
  // ORIENTACIN
  // =============================
  let orientationMode = 'north';

  function handleOrientation(e) {
  if (orientationMode !== 'device') return;
  if (e.alpha == null) return;

  map.setBearing(360 - e.alpha);
}

function toggleOrientation() {
  if (orientationMode === 'north') {
    orientationMode = 'device';
    window.addEventListener('deviceorientation', handleOrientation, true);
    alert('Orientaci贸n activada');
  } else {
    orientationMode = 'north';
    window.removeEventListener('deviceorientation', handleOrientation, true);
    map.setBearing(0);
    alert('Orientaci贸n al norte');
  }
}

  function requestOrientationPermission() {
    if (
      typeof DeviceOrientationEvent !== 'undefined' &&
      typeof DeviceOrientationEvent.requestPermission === 'function'
    ) {
      DeviceOrientationEvent.requestPermission().then(p => {
        if (p === 'granted') toggleOrientation();
      });
    } else {
      toggleOrientation();
    }
  }
</script>

</body>
</html>
